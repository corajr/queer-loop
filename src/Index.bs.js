// Generated by BUCKLESCRIPT VERSION 5.0.2, PLEASE EDIT WITH CARE
'use strict';

var $$Array = require("bs-platform/lib/js/array.js");
var Curry = require("bs-platform/lib/js/curry.js");
var Js_dict = require("bs-platform/lib/js/js_dict.js");
var Debouncer = require("re-debouncer/src/Debouncer.bs.js");
var ElementRe = require("bs-webapi/src/dom/nodes/ElementRe.js");
var Caml_int32 = require("bs-platform/lib/js/caml_int32.js");
var Pervasives = require("bs-platform/lib/js/pervasives.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");
var Caml_option = require("bs-platform/lib/js/caml_option.js");
var Hash$QueerLoop = require("./Hash.bs.js");
var Util$QueerLoop = require("./Util.bs.js");
var Scanner$QueerLoop = require("./Scanner.bs.js");
var QrCodeGen$QueerLoop = require("./QrCodeGen.bs.js");
var QueerCode$QueerLoop = require("./QueerCode.bs.js");
var UserMedia$QueerLoop = require("./UserMedia.bs.js");

var domain = "qqq.lu";

function setBackground(selector, bgCss) {
  return Util$QueerLoop.withQuerySelector(selector, (function (el) {
                el.style.setProperty("background", bgCss, "");
                return /* () */0;
              }));
}

var codeRegex = new RegExp("https:\\/\\/qqq.lu\\/#(.+)");

var defaultCode = QrCodeGen$QueerLoop.QrCode[/* _encodeText */0]("https://qqq.lu", QrCodeGen$QueerLoop.Ecc[/* low */0]);

var defaultHash = "fff";

var camerasRef = /* record */[/* contents : array */[]];

var cameraIndex = /* record */[/* contents */0];

function cycleCameras(scanner) {
  var n = camerasRef[0].length;
  cameraIndex[0] = Caml_int32.mod_(cameraIndex[0] + 1 | 0, n);
  return /* () */0;
}

function setSrc (img,src){
     img.src = src;};

var previousCodes = { };

var currentSignature = /* record */[/* contents */""];

function setCode(input) {
  var text = "https://" + (domain + ("/#" + input));
  Hash$QueerLoop.hexDigest("SHA-256", text).then((function (hash) {
          setBackground("body", "#" + hash.slice(0, 6));
          var code = Belt_Option.getWithDefault(QrCodeGen$QueerLoop.QrCode[/* encodeText */1](text, QrCodeGen$QueerLoop.Ecc[/* medium */1]), defaultCode);
          Belt_Option.map(Caml_option.nullable_to_opt(document.querySelector("#codeCanvas")), (function (canvas) {
                  QueerCode$QueerLoop.drawCanvas(canvas, code);
                  var url = canvas.toDataURL();
                  currentSignature[0] = hash;
                  previousCodes[hash] = url;
                  return /* () */0;
                }));
          Util$QueerLoop.withQuerySelector("#current", (function (img) {
                  var url = QueerCode$QueerLoop.getSvgDataUri(code, Js_dict.values(previousCodes));
                  return setSrc(img, url);
                }));
          return Promise.resolve(/* () */0);
        }));
  return /* () */0;
}

function getHash(param) {
  return window.location.hash;
}

function setHash(hash) {
  window.location.hash = hash;
  return /* () */0;
}

function onHashChange(param) {
  var hash = window.location.hash.slice(1);
  setCode(hash);
  Util$QueerLoop.withQuerySelector("#codeContents", (function (el) {
          el.innerText = decodeURIComponent(hash);
          return /* () */0;
        }));
  return /* () */0;
}

function setOpacity(elQuery, opacity) {
  return Belt_Option.map(Belt_Option.flatMap(Caml_option.nullable_to_opt(document.querySelector(elQuery)), ElementRe.asHtmlElement), (function (body) {
                body.style.setProperty("opacity", Pervasives.string_of_float(opacity), "");
                return /* () */0;
              }));
}

function onTick(ts) {
  var scaled = ts * 0.0005;
  var codeOpacity = 0.5 + Math.pow(Math.sin(scaled), 2.0) * 0.5;
  var maybeCanvas = document.querySelector("#codeCanvas");
  if (!(maybeCanvas == null)) {
    var ctx = maybeCanvas.getContext("2d");
    ctx.globalAlpha = codeOpacity;
  }
  requestAnimationFrame(onTick);
  return /* () */0;
}

function _onInput(param) {
  Util$QueerLoop.withQuerySelector("#codeContents", (function (el) {
          var text = el.innerText;
          return setHash(encodeURIComponent(text));
        }));
  return /* () */0;
}

var onInput = Debouncer.make(200, _onInput);

function init(param) {
  var initialHash = window.location.hash;
  if (initialHash === "") {
    setHash(defaultHash);
  } else {
    onHashChange(/* () */0);
  }
  Util$QueerLoop.withQuerySelector("#codeContents", (function (el) {
          el.addEventListener("input", (function (evt) {
                  return Curry._1(onInput, /* () */0);
                }));
          return /* () */0;
        }));
  var response = function (input) {
    if (input !== "") {
      Hash$QueerLoop.hexDigest("SHA-256", input).then((function (hexHash) {
              if (hexHash === currentSignature[0] || Belt_Option.isNone(Js_dict.get(previousCodes, hexHash))) {
                setHash(hexHash);
              }
              return Promise.resolve(/* () */0);
            }));
      return /* () */0;
    } else {
      return 0;
    }
  };
  UserMedia$QueerLoop.getCameras(/* () */0).then((function (cameras) {
            camerasRef[0] = cameras;
            return Promise.all($$Array.map((function (camera) {
                              var videoEl = document.createElement("video");
                              Util$QueerLoop.withQuerySelector("body", (function (body) {
                                      body.appendChild(videoEl);
                                      return /* () */0;
                                    }));
                              Scanner$QueerLoop.scanUsingDeviceId(videoEl, camera.deviceId, response);
                              return Promise.resolve(/* () */0);
                            }), cameras));
          })).catch((function (err) {
          console.error("getCameras failed", err);
          return Promise.resolve(/* array */[]);
        }));
  return /* () */0;
}

window.addEventListener("load", (function (param) {
        return init(/* () */0);
      }));

window.addEventListener("hashchange", (function (param) {
        return onHashChange(/* () */0);
      }));

exports.domain = domain;
exports.setBackground = setBackground;
exports.codeRegex = codeRegex;
exports.defaultCode = defaultCode;
exports.defaultHash = defaultHash;
exports.camerasRef = camerasRef;
exports.cameraIndex = cameraIndex;
exports.cycleCameras = cycleCameras;
exports.setSrc = setSrc;
exports.previousCodes = previousCodes;
exports.currentSignature = currentSignature;
exports.setCode = setCode;
exports.getHash = getHash;
exports.setHash = setHash;
exports.onHashChange = onHashChange;
exports.setOpacity = setOpacity;
exports.onTick = onTick;
exports._onInput = _onInput;
exports.onInput = onInput;
exports.init = init;
/* codeRegex Not a pure module */
