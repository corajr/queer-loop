// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE

import * as Caml_array from "bs-platform/lib/es6/caml_array.js";
import * as Caml_int32 from "bs-platform/lib/es6/caml_int32.js";
import * as Belt_Option from "bs-platform/lib/es6/belt_Option.js";
import * as Caml_option from "bs-platform/lib/es6/caml_option.js";
import * as Util$QueerLoop from "./Util.bs.js";
import * as Caml_splice_call from "bs-platform/lib/es6/caml_splice_call.js";
import * as QrCodeGen$QueerLoop from "./QrCodeGen.bs.js";

function getPathString(code, border) {
  var size = code.size;
  var modules = code.getModules();
  var parts = [];
  for(var y = 0; y < size; ++y){
    for(var x = 0; x < size; ++x){
      if (Caml_array.caml_array_get(Caml_array.caml_array_get(modules, y), x)) {
        parts.push("M" + (String(x + border | 0) + ("," + (String(y + border | 0) + "h1v1h-1z"))));
      }
      
    }
  }
  return parts.join(" ");
}

var svgNs = "http://www.w3.org/2000/svg";

function createQrCodePathElement(code, border) {
  var path = document.createElementNS(svgNs, "path");
  path.setAttribute("d", getPathString(code, border));
  path.setAttribute("class", "codePath");
  return path;
}

function createRainbowGradient(lightness, id) {
  var gradient = document.createElementNS(svgNs, "linearGradient");
  gradient.id = id;
  for(var i = 0; i <= 7; ++i){
    var stop = document.createElementNS(svgNs, "stop");
    stop.setAttribute("offset", (100.0 * i / 7.0).toString() + "%");
    stop.setAttribute("stop-color", "hsl(" + ((i / 8.0).toString() + ("turn,100%," + ((lightness * 100.0).toString() + "%)"))));
    gradient.appendChild(stop);
  }
  gradient.setAttribute("gradientTransform", "rotate(45)");
  return gradient;
}

var styleText = "\n   @namespace svg \"http://www.w3.org/2000/svg\";\n\n   svg|svg svg|svg, .background {\n     visibility: hidden;\n     transition: visibility 0s, opacity 0.5s;\n   }\n\n   svg|svg.animate, svg|svg.previous, svg|svg.active {\n      visibility: visible;\n   }\n\n   svg|svg.animate .background, svg|svg.previous .background, svg|svg.active .background {\n      visibility: visible;\n      opacity: 1.0;\n   }\n\n   svg|svg.animate.temporarilyInactive, svg|svg.animate.temporarilyInactive .background {\n      visibility: hidden;\n   }\n\n   .codeBackdrop {\n      fill: white;\n   }\n\n   .invert .codeBackdrop {\n      fill: black;\n   }\n\n   .codePath {\n      fill: url(#darkRainbow);\n   }\n\n   .invert .codePath {\n      fill: url(#lightRainbow);\n   }\n\n   .text, a, a:visited {\n      color: white;\n      mix-blend-mode: difference;\n   }\n\n   svg|text {\n      fill: url(#lightRainbow);\n   }\n\n   .invert svg|text {\n      fill: url(#darkRainbow);\n   }\n\n   .text {\n      font-size: 1.5px;\n      text-align: center;\n   }\n\n   .iconText {\n      font-size: 6px;\n      color: black;\n   }\n   .invert .iconText {\n      color: white;\n   }\n\n\n   svg|svg.previous g.codeGroup, svg|svg.active g.codeGroup {\n       opacity: 0.1;\n   }\n\n   svg|svg.active {\n       opacity: 1.0;\n       mix-blend-mode: screen;\n   }\n\n   svg|svg.previous {\n       opacity: 0.25;\n   }\n";

function createScript(string) {
  var script = document.createElementNS(svgNs, "script");
  script.textContent = string;
  return script;
}

function createStyle(param) {
  var style = document.createElementNS(svgNs, "style");
  style.setAttribute("type", "text/css");
  style.textContent = styleText;
  return style;
}

function addBackground(codeSvg, sizeWithBorder, dataURL) {
  var background = document.createElementNS(svgNs, "image");
  background.setAttribute("x", "0");
  background.setAttribute("y", "0");
  background.setAttribute("width", String(sizeWithBorder));
  background.setAttribute("height", String(sizeWithBorder));
  background.setAttribute("href", dataURL);
  background.setAttribute("class", "background");
  return Belt_Option.map(Caml_option.nullable_to_opt(codeSvg.querySelector(".codeGroup")), (function (codeGroup) {
                return codeSvg.insertBefore(background, codeGroup);
              }));
}

function createTimeLink(href, timestamp, localeString, sizeWithBorder, border) {
  var timeText = document.createElementNS(svgNs, "text");
  timeText.setAttribute("x", (sizeWithBorder / 2.0).toString());
  timeText.setAttribute("y", (border / 2.0).toString());
  timeText.setAttribute("font-size", (border / 2.0).toString() + "px");
  timeText.setAttribute("text-anchor", "middle");
  timeText.setAttribute("alignment-baseline", "middle");
  timeText.setAttribute("style", "text-align: center; font-family: \"Courier New\", monospace;");
  timeText.setAttribute("textLength", "90%");
  timeText.textContent = localeString;
  var timeLink = document.createElementNS(svgNs, "a");
  timeLink.setAttribute("href", href);
  timeLink.appendChild(timeText);
  return timeLink;
}

function createTextBox(text, border, sizeWithBorder, additionalClassesOpt, unit) {
  var additionalClasses = additionalClassesOpt !== undefined ? additionalClassesOpt : [];
  var htmlContainer = document.createElementNS(svgNs, "foreignObject");
  htmlContainer.setAttribute("x", "0");
  htmlContainer.setAttribute("y", String((sizeWithBorder - border | 0) + 1 | 0));
  htmlContainer.setAttribute("width", String(sizeWithBorder));
  htmlContainer.setAttribute("height", String(border));
  var textDiv = document.createElementNS(Util$QueerLoop.htmlNs, "div");
  textDiv.textContent = text;
  var classes = textDiv.classList;
  classes.add("text");
  Caml_splice_call.spliceObjApply(classes, "add", [additionalClasses]);
  htmlContainer.appendChild(textDiv);
  return htmlContainer;
}

function createCodeSvg(href, code, hash, localeString, timestamp, border) {
  var size = code.size;
  var sizeWithBorder = size + (border << 1) | 0;
  var viewBox = "0 0 " + (String(sizeWithBorder) + (" " + (String(sizeWithBorder) + "")));
  var codeSvg = document.createElementNS(svgNs, "svg");
  codeSvg.id = "code" + hash;
  codeSvg.setAttribute("viewBox", viewBox);
  var codeGroup = document.createElementNS(svgNs, "g");
  var scale = size / sizeWithBorder;
  codeGroup.setAttribute("transform", "translate(" + (String(border) + ("," + (String(border) + (") scale(" + (String(scale) + ")"))))));
  var rect = document.createElementNS(svgNs, "rect");
  rect.setAttribute("width", "100%");
  rect.setAttribute("height", "100%");
  rect.setAttribute("class", "codeBackdrop");
  codeGroup.appendChild(rect);
  var path = createQrCodePathElement(code, border);
  codeGroup.appendChild(path);
  codeGroup.setAttribute("class", "codeGroup");
  codeSvg.appendChild(codeGroup);
  var metadataGroup = document.createElementNS(svgNs, "g");
  metadataGroup.appendChild(createTimeLink(href, timestamp, localeString, sizeWithBorder, border));
  var codeText = createTextBox(href, border, sizeWithBorder, undefined, undefined);
  metadataGroup.appendChild(codeText);
  codeSvg.appendChild(metadataGroup);
  return codeSvg;
}

function createSvgSkeleton(hash) {
  var svg = document.createElementNS(svgNs, "svg");
  svg.setAttribute("viewBox", "0 0 1 1");
  svg.setAttribute("class", "root");
  var defs = document.createElementNS(svgNs, "defs");
  var lightRainbowGradient = createRainbowGradient(0.95, "lightRainbow");
  var darkRainbowGradient = createRainbowGradient(0.1, "darkRainbow");
  defs.appendChild(lightRainbowGradient);
  defs.appendChild(darkRainbowGradient);
  svg.appendChild(defs);
  Util$QueerLoop.withQuerySelectorDom("script.main", (function (main) {
          var script = createScript(main.textContent);
          svg.appendChild(script);
          
        }));
  var style = createStyle(undefined);
  svg.appendChild(style);
  var centralGroup = document.createElementNS(svgNs, "g");
  centralGroup.id = "centralGroup";
  svg.appendChild(centralGroup);
  return svg;
}

function createIconSvg(code, border, bg, hash) {
  var size = code.size;
  var sizeWithBorder = size + (border << 1) | 0;
  var viewBox = "0 0 " + (String(sizeWithBorder) + (" " + (String(sizeWithBorder) + "")));
  var svg = document.createElementNS(svgNs, "svg");
  svg.setAttribute("viewBox", viewBox);
  svg.setAttribute("class", "icon");
  var defs = document.createElementNS(svgNs, "defs");
  var lightRainbowGradient = createRainbowGradient(0.95, "lightRainbow");
  var darkRainbowGradient = createRainbowGradient(0.1, "darkRainbow");
  defs.appendChild(lightRainbowGradient);
  defs.appendChild(darkRainbowGradient);
  svg.appendChild(defs);
  if (bg) {
    var rect = document.createElementNS(svgNs, "rect");
    rect.setAttribute("width", "100%");
    rect.setAttribute("height", "100%");
    rect.setAttribute("class", "codeBackdrop");
    svg.appendChild(rect);
  }
  var rect$1 = document.createElementNS(svgNs, "rect");
  rect$1.setAttribute("width", "100%");
  rect$1.setAttribute("height", "100%");
  rect$1.setAttribute("fill", "#" + hash.slice(0, 6));
  svg.appendChild(rect$1);
  var path = createQrCodePathElement(code, border);
  svg.appendChild(path);
  return /* tuple */[
          svg,
          sizeWithBorder
        ];
}

function createIconFromText(text) {
  var code = QrCodeGen$QueerLoop.QrCode.encodeText(text, QrCodeGen$QueerLoop.Ecc.low);
  if (code === undefined) {
    return document.createElementNS(Util$QueerLoop.htmlNs, "div");
  }
  var code$1 = Caml_option.valFromOption(code);
  var size = code$1.size;
  var sizeWithBorder = size + 12 | 0;
  var viewBox = "0 0 " + (String(sizeWithBorder) + (" " + (String(sizeWithBorder) + "")));
  var svg = document.createElementNS(svgNs, "svg");
  svg.setAttribute("viewBox", viewBox);
  svg.setAttribute("class", "icon");
  var defs = document.createElementNS(svgNs, "defs");
  var lightRainbowGradient = createRainbowGradient(0.95, "lightRainbow");
  var darkRainbowGradient = createRainbowGradient(0.1, "darkRainbow");
  defs.appendChild(lightRainbowGradient);
  defs.appendChild(darkRainbowGradient);
  svg.appendChild(defs);
  var rect = document.createElementNS(svgNs, "rect");
  rect.setAttribute("width", "100%");
  rect.setAttribute("height", "100%");
  rect.setAttribute("class", "codeBackdrop");
  svg.appendChild(rect);
  var path = createQrCodePathElement(code$1, 6);
  svg.appendChild(path);
  var codeText = createTextBox(text, 6, sizeWithBorder, ["iconText"], undefined);
  codeText.setAttribute("y", String(sizeWithBorder - 6 | 0));
  svg.appendChild(codeText);
  svg.setAttribute("width", String((sizeWithBorder << 1)));
  svg.setAttribute("height", String((sizeWithBorder << 1)));
  return svg;
}

var $$XMLSerializer = { };

function svgToDataURL(svg) {
  var xmlSerializer = new XMLSerializer();
  var str = xmlSerializer.serializeToString(svg);
  return "data:image/svg+xml;utf8," + encodeURIComponent(str);
}

function svgToBlob(svg) {
  var xmlSerializer = new XMLSerializer();
  var str = xmlSerializer.serializeToString(svg);
  return new Blob([str], {
              type: "image/svg+xml;charset=utf-8"
            });
}

function svgToImg(svg) {
  var svgUrl = svgToDataURL(svg);
  var svgImg = document.createElementNS(Util$QueerLoop.htmlNs, "img");
  svgImg.setAttribute("src", svgUrl);
  svgImg.setAttribute("width", "480");
  svgImg.setAttribute("height", "480");
  return svgImg;
}

function svgToBlobObjectURL(svg) {
  return URL.createObjectURL(svgToBlob(svg));
}

function svgToPng(svg, widthOpt, heightOpt, unit) {
  var width = widthOpt !== undefined ? widthOpt : 480;
  var height = heightOpt !== undefined ? heightOpt : 480;
  var svgBlob = svgToBlob(svg);
  var svgUrl = URL.createObjectURL(svgBlob);
  var svgImg = document.createElementNS(Util$QueerLoop.htmlNs, "img");
  var widthStr = String(width);
  var heightStr = String(height);
  svgImg.addEventListener("load", (function (param) {
          Util$QueerLoop.withQuerySelectorDom("#snapshotCanvas", (function (canvas) {
                  var ctx = canvas.getContext("2d");
                  ctx.drawImage(svgImg, 0, 0);
                  URL.revokeObjectURL(svgUrl);
                  
                }));
          
        }));
  svgImg.setAttribute("src", svgUrl);
  svgImg.setAttribute("width", widthStr);
  svgImg.setAttribute("height", heightStr);
  return svgImg;
}

function codeToImage(code, border, hash) {
  var match = createIconSvg(code, border, false, hash);
  var sizeStr = String(match[1]);
  var iconSvgUrl = svgToDataURL(match[0]);
  var iconSvgImg = document.createElementNS(Util$QueerLoop.htmlNs, "img");
  iconSvgImg.setAttribute("src", iconSvgUrl);
  iconSvgImg.setAttribute("width", sizeStr);
  iconSvgImg.setAttribute("height", sizeStr);
  return iconSvgImg;
}

function drawCanvas(canvas, code) {
  var size = code.size;
  var width = size + 4 | 0;
  if (canvas.width !== width) {
    canvas.width = width;
    canvas.height = width;
  }
  var ctx = canvas.getContext("2d");
  ctx.globalCompositeOperation = "difference";
  ctx.fillStyle = "#FFFFFF";
  for(var y = -2 ,y_finish = size + 2 | 0; y <= y_finish; ++y){
    for(var x = -2 ,x_finish = size + 2 | 0; x <= x_finish; ++x){
      if (code.getModule(x, y)) {
        ctx.fillRect(x + 2 | 0, y + 2 | 0, 1, 1);
      }
      
    }
  }
  
}

function clipCanvas(canvas, code) {
  var size = code.size;
  var width = size + 12 | 0;
  var scale = Caml_int32.div(canvas.width, width);
  var ctx = canvas.getContext("2d");
  ctx.beginPath();
  for(var y = -6 ,y_finish = size + 6 | 0; y <= y_finish; ++y){
    for(var x = -6 ,x_finish = size + 6 | 0; x <= x_finish; ++x){
      if (!code.getModule(x, y)) {
        ctx.rect(Caml_int32.imul(x + 6 | 0, scale), Caml_int32.imul(y + 6 | 0, scale), scale, scale);
      }
      
    }
  }
  ctx.clip();
  
}

var lightRainbowLightness = 0.95;

var darkRainbowLightness = 0.1;

export {
  lightRainbowLightness ,
  darkRainbowLightness ,
  getPathString ,
  svgNs ,
  createQrCodePathElement ,
  createRainbowGradient ,
  styleText ,
  createScript ,
  createStyle ,
  addBackground ,
  createTimeLink ,
  createTextBox ,
  createCodeSvg ,
  createSvgSkeleton ,
  createIconSvg ,
  createIconFromText ,
  $$XMLSerializer ,
  svgToDataURL ,
  svgToBlob ,
  svgToImg ,
  svgToBlobObjectURL ,
  svgToPng ,
  codeToImage ,
  drawCanvas ,
  clipCanvas ,
  
}
/* Util-QueerLoop Not a pure module */
